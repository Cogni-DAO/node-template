name: Auto-merge release PRs

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: read

jobs:
  auto-merge-release:
    # Only run on release/* PRs targeting main
    if: |
      github.event.pull_request.base.ref == 'main' &&
      startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest
    steps:
      - name: Check if ready to merge
        id: ready
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_AUTOMATION_BOT_PAT }}
        run: |
          # Get PR details via GitHub CLI
          PR_DATA=$(gh pr view ${{ github.event.pull_request.number }} --json state,isDraft,reviewDecision,statusCheckRollup)

          # Extract values
          STATE=$(echo "$PR_DATA" | jq -r '.state')
          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.isDraft')
          REVIEW_DECISION=$(echo "$PR_DATA" | jq -r '.reviewDecision')

          # Check required status checks
          REQUIRED_CHECKS=("ci" "stack-test" "require-pinned-release-branch")
          ALL_PASSED=true

          for check in "${REQUIRED_CHECKS[@]}"; do
            STATUS=$(echo "$PR_DATA" | jq -r --arg check "$check" '.statusCheckRollup[] | select(.context == $check or .checkRun.name == $check) | .conclusion')
            if [[ "$STATUS" != "SUCCESS" ]] && [[ "$STATUS" != "NEUTRAL" ]]; then
              ALL_PASSED=false
            fi
          done

          # Determine if ready to merge
          if [[ "$STATE" == "OPEN" ]] && \
             [[ "$IS_DRAFT" == "false" ]] && \
             [[ "$REVIEW_DECISION" == "APPROVED" ]] && \
             [[ "$ALL_PASSED" == "true" ]]; then
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "ðŸŸ¢ PR #${{ github.event.pull_request.number }} is ready to auto-merge"
          else
            echo "ready=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto-merge release PR
        if: steps.ready.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_AUTOMATION_BOT_PAT }}
        run: |
          echo "ðŸš€ Auto-merging release PR #${{ github.event.pull_request.number }}"

          # Merge will be authored by the owner of ACTIONS_AUTOMATION_BOT_PAT (Cogni-1729)
          # Merge the PR using GitHub CLI (creates merge commit, no-ff)
          gh pr merge ${{ github.event.pull_request.number }} \
            --merge \
            --subject "Merge ${{ github.event.pull_request.head.ref }} into main" \
            --body "Automated merge by Cogni-1729 automation after required checks passed."

          echo "âœ… Successfully merged release PR"
