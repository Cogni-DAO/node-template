name: Auto-merge release PRs

# Behavior:
# - Not on main: job skipped
# - On main but not ready: job fails (red), no merge
# - On main and ready: job succeeds and merges

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: read

jobs:
  auto-merge-release:
    # Only run on release/* PRs targeting main
    if: |
      github.event.pull_request.base.ref == 'main' &&
      startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if ready to merge
        id: ready
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_AUTOMATION_BOT_PAT }}
        run: |
          # Get PR details via GitHub CLI
          PR_DATA=$(gh pr view ${{ github.event.pull_request.number }} --json state,isDraft,reviewDecision,statusCheckRollup)

          # Extract values
          STATE=$(echo "$PR_DATA" | jq -r '.state')
          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.isDraft')
          REVIEW_DECISION=$(echo "$PR_DATA" | jq -r '.reviewDecision')

          # Check required status checks
          REQUIRED_CHECKS=("ci" "stack-test" "require-pinned-release-branch")
          ALL_PASSED=true

          for check in "${REQUIRED_CHECKS[@]}"; do
            STATUS=$(echo "$PR_DATA" | jq -r --arg check "$check" '
              [
                (.statusCheckRollup // [])
                | .[]
                | select(.name == $check)
                | .conclusion
              ]
              | if length == 0 then
                  "MISSING"
                elif any(. != "SUCCESS" and . != "NEUTRAL") then
                  "FAIL"
                else
                  "SUCCESS"
                end
            ')
            
            if [[ "$STATUS" != "SUCCESS" ]]; then
              ALL_PASSED=false
            fi
          done

          # Determine if ready to merge
          if [[ "$STATE" == "OPEN" ]] && \
             [[ "$IS_DRAFT" == "false" ]] && \
             [[ "$REVIEW_DECISION" == "APPROVED" ]] && \
             [[ "$ALL_PASSED" == "true" ]]; then
            echo "ready=true" >> "$GITHUB_OUTPUT"
            echo "üü¢ PR #${{ github.event.pull_request.number }} is ready to auto-merge"
          else
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "‚ùå PR #${{ github.event.pull_request.number }} is NOT ready to auto-merge"
            exit 1
          fi

      - name: Auto-merge release PR
        if: steps.ready.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_AUTOMATION_BOT_PAT }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "üöÄ Auto-merging release PR #${{ github.event.pull_request.number }}"

          # Merge will be authored by the owner of ACTIONS_AUTOMATION_BOT_PAT (Cogni-1729)
          # Use env var to prevent shell injection via malicious branch names
          SUBJECT="Merge ${HEAD_REF} into main"

          gh pr merge ${{ github.event.pull_request.number }} \
            --merge \
            --subject "$SUBJECT" \
            --body "Automated merge by Cogni-1729 automation after required checks passed."

          echo "‚úÖ Successfully merged release PR"
