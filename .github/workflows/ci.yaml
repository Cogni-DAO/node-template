name: CI

on:
  pull_request:
  push:
    branches: [staging, main]

permissions:
  contents: read
  actions: read # Required for CI telemetry to fetch job logs
  packages: read # Required for pulling migrator images from GHCR

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NEXT_TELEMETRY_DISABLED: 1
  NODE_VERSION: "20"
  # Temporal env vars - required by serverEnv() Zod schema
  # All CI jobs (including stack-test) use localhost:7233 since tests run on host, not in Docker
  TEMPORAL_ADDRESS: localhost:7233
  TEMPORAL_NAMESPACE: cogni-test
  TEMPORAL_TASK_QUEUE: scheduler-tasks

jobs:
  # Fast gate: install → typecheck → lint
  static:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
      LITELLM_MASTER_KEY: build-key
      AUTH_SECRET: tNf5lFM9yMhdgwS5yeQB8Y2kmigblBqobkvI2XN2brg=
      SCHEDULER_API_TOKEN: test-scheduler-api-token-for-ci-min32chars

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm packages:build

      - name: Type check
        run: pnpm typecheck

      - name: Lint
        run: pnpm lint

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}

  unit:
    runs-on: ubuntu-latest
    needs: static
    env:
      NODE_ENV: test
      LITELLM_MASTER_KEY: build-key
      AUTH_SECRET: tNf5lFM9yMhdgwS5yeQB8Y2kmigblBqobkvI2XN2brg=
      SCHEDULER_API_TOKEN: test-scheduler-api-token-for-ci-min32chars

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm packages:build

      - name: Repository policy check
        run: pnpm check:root-layout

      - name: REUSE SPDX compliance
        uses: fsfe/reuse-action@772649cfa03a64a08c458c7cca9a6a473d74e7f9 # v6

      - name: Validate chain configuration
        run: pnpm validate:chain

      - name: Format check
        run: pnpm format:check

      - name: UI tokens check
        run: bash scripts/check-ui-tokens.sh

      - name: Documentation check
        run: pnpm check:docs

      - name: Architecture check
        run: pnpm arch:check

      - name: Unit + contract coverage tests
        run: pnpm test:ci

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-${{ github.sha }}
          path: |
            coverage/lcov.info
            coverage/coverage-summary.json
          retention-days: 1
          if-no-files-found: error

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}

  integration:
    runs-on: ubuntu-latest
    needs: static
    env:
      NODE_ENV: test
      LITELLM_MASTER_KEY: build-key
      AUTH_SECRET: tNf5lFM9yMhdgwS5yeQB8Y2kmigblBqobkvI2XN2brg=
      SCHEDULER_API_TOKEN: test-scheduler-api-token-for-ci-min32chars

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm packages:build

      - name: Install ripgrep
        uses: taiki-e/install-action@735e5933943122c5ac182670a935f54a949265c1 # v2
        with:
          tool: ripgrep

      - name: Verify ripgrep
        run: rg --version

      - name: Build sandbox runtime image
        run: pnpm sandbox:docker:build

      - name: Integration tests (testcontainers)
        run: pnpm test:int

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}

  sonar:
    runs-on: ubuntu-latest
    needs: unit
    if: needs.unit.result == 'success'
    permissions:
      contents: read
      pull-requests: write # Required for PR decoration
      actions: read # Required for CI telemetry

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0 # Required for SonarCloud git blame

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download coverage artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: coverage-${{ github.sha }}
          path: coverage/

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@884b79409bbd464b2a59edc326a4b77dc56b2195 # v5.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
          GITHUB_TOKEN: ${{ secrets.ACTIONS_AUTOMATION_BOT_PAT }}

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}

  stack-test:
    runs-on: ubuntu-latest
    needs: static
    env:
      NODE_ENV: test
      APP_ENV: test
      # Database provisioning (provision.sh creates roles + databases)
      # Root credentials for superuser connection
      POSTGRES_ROOT_USER: postgres
      POSTGRES_ROOT_PASSWORD: postgres
      # App role (RLS enforced) - matches DATABASE_URL user
      APP_DB_USER: user
      APP_DB_PASSWORD: password
      # Service role (BYPASSRLS) - matches DATABASE_SERVICE_URL user
      APP_DB_SERVICE_USER: user_service
      APP_DB_SERVICE_PASSWORD: service_password
      # Database name
      APP_DB_NAME: cogni_template_test
      POSTGRES_DB: cogni_template_test
      # Image naming base (APP_IMAGE/MIGRATOR_IMAGE derived in step below)
      IMAGE_NAME: cogni-template-ci
      IMAGE_TAG: ${{ github.sha }}
      DOMAIN: localhost
      LITELLM_MASTER_KEY: test-key
      LITELLM_BASE_URL: http://localhost:4000
      OPENROUTER_API_KEY: test-key
      EVM_RPC_URL: https://base-mainnet.g.alchemy.com/v2/fake-test-key
      TEST_BASE_URL: https://localhost/
      AUTH_SECRET: tNf5lFM9yMhdgwS5yeQB8Y2kmigblBqobkvI2XN2brg=
      METRICS_TOKEN: test-metrics-token-for-stack-tests
      SCHEDULER_API_TOKEN: test-scheduler-api-token-for-ci-min32chars
      # LiteLLM test config routes to mock-openai-api (no real provider keys)
      LITELLM_CONFIG: litellm.test.config.yaml
      # Temporal env vars for HOST-based test process (vitest runs on host, not in Docker)
      # App container gets temporal:7233 from docker-compose.dev.yml; tests need localhost:7233
      TEMPORAL_ADDRESS: localhost:7233
      TEMPORAL_NAMESPACE: cogni-test
      TEMPORAL_TASK_QUEUE: scheduler-tasks
      # Container-side DSNs (postgres:5432 = Docker internal DNS)
      # These are passed to docker-compose for app, migrator, scheduler-worker containers
      DATABASE_URL: postgresql://user:password@postgres:5432/cogni_template_test?sslmode=disable
      DATABASE_SERVICE_URL: postgresql://user_service:service_password@postgres:5432/cogni_template_test?sslmode=disable
      # git-sync HTTPS clone (same path as prod — no file:// shortcut)
      COGNI_REPO_URL: https://github.com/${{ github.repository }}.git
      COGNI_REPO_REF: ${{ github.sha }}
      GIT_READ_TOKEN: ${{ secrets.GIT_READ_TOKEN }}
      GIT_READ_USERNAME: Cogni-1729
      # All fake keys: DO NOT expose any real keys here
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm packages:build

      - name: Install ripgrep
        uses: taiki-e/install-action@735e5933943122c5ac182670a935f54a949265c1 # v2
        with:
          tool: ripgrep

      - name: Derive image tags
        run: |
          # INV-COUPLED-TAGS-NO-GUESSING: derive APP_IMAGE from IMAGE_NAME + IMAGE_TAG
          echo "APP_IMAGE=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Compute migrator fingerprint and tag
        run: |
          FINGERPRINT=$(platform/ci/scripts/compute_migrator_fingerprint.sh)
          echo "MIGRATOR_FINGERPRINT=$FINGERPRINT" >> $GITHUB_ENV
          # Content-addressed migrator tag (decoupled from app commit, lowercase for GHCR)
          REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "MIGRATOR_IMAGE=ghcr.io/${REPO}:migrate-${FINGERPRINT}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Login to GHCR (best-effort for migrator pull)
        uses: docker/login-action@v3
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        continue-on-error: true
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull OpenClaw gateway image
        run: |
          docker pull ghcr.io/cogni-dao/node-template:openclaw-gateway-latest
          docker tag ghcr.io/cogni-dao/node-template:openclaw-gateway-latest openclaw-outbound-headers:latest

      - name: Build app image (with GHA cache)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          target: runner
          tags: ${{ env.APP_IMAGE }}
          load: true
          cache-from: type=gha,scope=stack-test
          cache-to: type=gha,mode=max,scope=stack-test

      - name: Try pull migrator by fingerprint (skip build if present)
        id: pull_migrator
        continue-on-error: true
        run: |
          echo "Trying to pull $MIGRATOR_IMAGE"
          docker pull "$MIGRATOR_IMAGE"

      - name: Build migrator image (fallback if pull failed)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        if: steps.pull_migrator.outcome != 'success'
        with:
          context: .
          target: migrator
          tags: ${{ env.MIGRATOR_IMAGE }}
          load: true
          cache-from: type=gha,scope=stack-test
          cache-to: type=gha,mode=max,scope=stack-test

      - name: Build scheduler-worker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: services/scheduler-worker/Dockerfile
          tags: cogni-scheduler-worker-local
          load: true
          cache-from: type=gha,scope=scheduler-worker
          cache-to: type=gha,mode=max,scope=scheduler-worker

      - name: Build sandbox runtime image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: services/sandbox-runtime
          file: services/sandbox-runtime/Dockerfile
          tags: cogni-sandbox-runtime:latest
          load: true
          cache-from: type=gha,scope=sandbox-runtime
          cache-to: type=gha,mode=max,scope=sandbox-runtime

      - name: Start app + DB + Temporal stack
        run: |
          docker network create cogni-edge || true
          # Images pre-built with GHA cache; no --build needed
          # Temporal services required for schedule CRUD + execution tests
          # scheduler-worker required for workflow execution tests
          docker compose -f platform/infra/services/runtime/docker-compose.dev.yml \
            --profile sandbox-openclaw \
            up -d app postgres litellm mock-llm caddy temporal-postgres temporal temporal-ui scheduler-worker git-sync llm-proxy-openclaw openclaw-gateway

      - name: Probe container-boundary (git-sync volume)
        run: platform/ci/scripts/probe-repo-volume.sh

      - name: Provision database roles
        run: |
          docker compose -f platform/infra/services/runtime/docker-compose.dev.yml \
            --profile bootstrap run --rm db-provision

      - name: Run migrations
        run: |
          docker compose -f platform/infra/services/runtime/docker-compose.dev.yml \
            --profile bootstrap run --rm db-migrate

      - name: Run stack tests
        run: pnpm test:stack:docker
        env:
          # Host-side vitest needs repo checkout; compose uses /repo/current default
          COGNI_REPO_PATH: ${{ github.workspace }}
          # Host-side DSNs for vitest (override job-level container DSNs)
          # Vitest runs on host, connects via port-forwarded localhost:55432
          DATABASE_URL: postgresql://user:password@localhost:55432/cogni_template_test
          DATABASE_SERVICE_URL: postgresql://user_service:service_password@localhost:55432/cogni_template_test
        # Note: wait-for-probes.ts globalSetup polls /livez then /readyz before tests run

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}
          compose_file: platform/infra/services/runtime/docker-compose.dev.yml

      - name: Upload failure context artifact
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ci-failure-context-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ runner.temp }}/ci-job.log
          if-no-files-found: warn
          retention-days: 14

      - name: Teardown stack
        if: always()
        run: |
          docker compose -f platform/infra/services/runtime/docker-compose.dev.yml down -v
