name: CI

on:
  pull_request:
  push:
    branches: [staging, main]

permissions:
  contents: read
  actions: read # Required for CI telemetry to fetch job logs
  packages: read # Required for pulling migrator images from GHCR

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NEXT_TELEMETRY_DISABLED: 1
  NODE_VERSION: "20"

jobs:
  # Fast gate: install → typecheck → lint
  static:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
      LITELLM_MASTER_KEY: build-key
      AUTH_SECRET: tNf5lFM9yMhdgwS5yeQB8Y2kmigblBqobkvI2XN2brg=

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build package references
        run: pnpm exec tsc -b

      - name: Type check
        run: pnpm typecheck

      - name: Lint
        run: pnpm lint

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}

  unit:
    runs-on: ubuntu-latest
    needs: static
    env:
      NODE_ENV: test
      LITELLM_MASTER_KEY: build-key
      AUTH_SECRET: tNf5lFM9yMhdgwS5yeQB8Y2kmigblBqobkvI2XN2brg=

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build package references
        run: pnpm exec tsc -b

      - name: Repository policy check
        run: pnpm check:root-layout

      - name: REUSE SPDX compliance
        uses: fsfe/reuse-action@772649cfa03a64a08c458c7cca9a6a473d74e7f9 # v6

      - name: Validate chain configuration
        run: pnpm validate:chain

      - name: Format check
        run: pnpm format:check

      - name: UI tokens check
        run: bash scripts/check-ui-tokens.sh

      - name: Documentation check
        run: pnpm check:docs

      - name: Architecture check
        run: pnpm arch:check

      - name: Unit + contract coverage tests
        run: pnpm test:ci

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-${{ github.sha }}
          path: |
            coverage/lcov.info
            coverage/coverage-summary.json
          retention-days: 1
          if-no-files-found: error

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}

  integration:
    runs-on: ubuntu-latest
    needs: static
    env:
      NODE_ENV: test
      LITELLM_MASTER_KEY: build-key
      AUTH_SECRET: tNf5lFM9yMhdgwS5yeQB8Y2kmigblBqobkvI2XN2brg=

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Integration tests (testcontainers)
        run: pnpm test:int

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}

  sonar:
    runs-on: ubuntu-latest
    needs: unit
    if: needs.unit.result == 'success'
    permissions:
      contents: read
      pull-requests: write # Required for PR decoration
      actions: read # Required for CI telemetry

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0 # Required for SonarCloud git blame

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download coverage artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: coverage-${{ github.sha }}
          path: coverage/

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@884b79409bbd464b2a59edc326a4b77dc56b2195 # v5.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
          GITHUB_TOKEN: ${{ secrets.ACTIONS_AUTOMATION_BOT_PAT }}

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}

  stack-test:
    runs-on: ubuntu-latest
    needs: static
    env:
      NODE_ENV: test
      APP_ENV: test
      # Database config for test connection to containers (not app config, which connects postgres:5432)
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: cogni_template_test
      DB_HOST: postgres
      DB_PORT: 55432
      # Image naming base (APP_IMAGE/MIGRATOR_IMAGE derived in step below)
      IMAGE_NAME: cogni-template-ci
      IMAGE_TAG: ${{ github.sha }}
      DOMAIN: localhost
      LITELLM_MASTER_KEY: test-key
      OPENROUTER_API_KEY: test-key
      EVM_RPC_URL: https://base-mainnet.g.alchemy.com/v2/fake-test-key
      TEST_BASE_URL: https://localhost/
      AUTH_SECRET: tNf5lFM9yMhdgwS5yeQB8Y2kmigblBqobkvI2XN2brg=
      METRICS_TOKEN: test-metrics-token-for-stack-tests
      # All fake keys: DO NOT expose any real keys here
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Derive image tags
        run: |
          # INV-COUPLED-TAGS-NO-GUESSING: derive APP_IMAGE from IMAGE_NAME + IMAGE_TAG
          echo "APP_IMAGE=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Compute migrator fingerprint and tag
        run: |
          FINGERPRINT=$(platform/ci/scripts/compute_migrator_fingerprint.sh)
          echo "MIGRATOR_FINGERPRINT=$FINGERPRINT" >> $GITHUB_ENV
          # Content-addressed migrator tag (decoupled from app commit, lowercase for GHCR)
          REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "MIGRATOR_IMAGE=ghcr.io/${REPO}:migrate-${FINGERPRINT}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Login to GHCR (best-effort for migrator pull)
        uses: docker/login-action@v3
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        continue-on-error: true
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build app image (with GHA cache)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          target: runner
          tags: ${{ env.APP_IMAGE }}
          load: true
          cache-from: type=gha,scope=stack-test
          cache-to: type=gha,mode=max,scope=stack-test

      - name: Try pull migrator by fingerprint (skip build if present)
        id: pull_migrator
        continue-on-error: true
        run: |
          echo "Trying to pull $MIGRATOR_IMAGE"
          docker pull "$MIGRATOR_IMAGE"

      - name: Build migrator image (fallback if pull failed)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        if: steps.pull_migrator.outcome != 'success'
        with:
          context: .
          target: migrator
          tags: ${{ env.MIGRATOR_IMAGE }}
          load: true
          cache-from: type=gha,scope=stack-test
          cache-to: type=gha,mode=max,scope=stack-test

      - name: Start app + DB stack
        run: |
          docker network create cogni-edge || true
          # Images pre-built with GHA cache; no --build needed
          docker compose -f platform/infra/services/runtime/docker-compose.dev.yml \
            up -d app postgres litellm caddy

      - name: Run migrations
        run: |
          docker compose -f platform/infra/services/runtime/docker-compose.dev.yml \
            --profile bootstrap run --rm db-migrate

      - name: Run stack tests
        run: pnpm test:stack:docker
        # Note: wait-for-probes.ts globalSetup polls /livez then /readyz before tests run

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}
          compose_file: platform/infra/services/runtime/docker-compose.dev.yml

      - name: Upload failure context artifact
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ci-failure-context-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ runner.temp }}/ci-job.log
          if-no-files-found: warn
          retention-days: 14

      - name: Teardown stack
        if: always()
        run: |
          docker compose -f platform/infra/services/runtime/docker-compose.dev.yml down -v
