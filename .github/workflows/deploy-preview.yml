name: Deploy (Preview)

on:
  workflow_run:
    workflows: ["Build & Test Preview"]
    types: [completed]

permissions:
  contents: read
  packages: write
  pull-requests: write

concurrency:
  group: deploy-preview-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

jobs:
  deploy-image:
    runs-on: ubuntu-latest
    environment: preview
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    env:
      NEXT_TELEMETRY_DISABLED: 1
      PR_NUMBER: ${{ github.event.pull_request.number || github.event.inputs.pr_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set image vars
        id: image_vars
        run: |
          # Ensure IMAGE_NAME is lowercase for Docker registry compatibility
          IMAGE_NAME=$(echo "ghcr.io/${{ github.repository }}" | tr '[:upper:]' '[:lower:]')

          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          else
            IMAGE_TAG="app-${GITHUB_SHA}"
          fi

          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Setup SSH deploy key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write key file
          echo "$SSH_DEPLOY_KEY" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Known hosts
          ssh-keyscan -H "$VM_HOST" >> ~/.ssh/known_hosts
        env:
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
          VM_HOST: ${{ secrets.VM_HOST }}

      - name: Deploy to Cherry Servers (Preview)
        env:
          DEPLOY_ENVIRONMENT: preview
          APP_IMAGE: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          DOMAIN: ${{ secrets.DOMAIN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          LITELLM_MASTER_KEY: ${{ secrets.LITELLM_MASTER_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VM_HOST: ${{ secrets.VM_HOST }}
        run: platform/ci/scripts/deploy.sh

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preview-deployment-artifacts-pr${{ env.PR_NUMBER }}-${{ github.run_id }}
          path: ${{ runner.temp }}/deploy-${{ github.run_id }}/
          if-no-files-found: warn
          retention-days: 14

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewDomain = '${{ secrets.DOMAIN }}';
            const imageTag = process.env.IMAGE_TAG;
            const imageName = process.env.IMAGE_NAME;
            const commitSha = process.env.GITHUB_SHA;

            const body = `## ðŸš€ Preview Deployment

            **Preview URL:** https://${previewDomain}
            **AI API URL:** https://ai.${previewDomain}
            **Image:** \`${imageName}:${imageTag}\`
            **Commit:** \`${commitSha}\`

            ### Services Available
            - ðŸŽ¯ **Main App:** [${previewDomain}](https://${previewDomain})
            - ðŸ¤– **LiteLLM AI:** [ai.${previewDomain}](https://ai.${previewDomain})
            - ðŸ” **Health Check:** [${previewDomain}/api/v1/meta/health](https://${previewDomain}/api/v1/meta/health)
            - ðŸ¤– **AI Health Check:** [ai.${previewDomain}/health/readiness](https://ai.${previewDomain}/health/readiness)

            > This preview will be updated automatically when you push new commits to this PR.`;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Preview Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Preview URL:** https://${{ secrets.DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "**AI API URL:** https://ai.${{ secrets.DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${IMAGE_NAME}:${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ env.PR_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${GITHUB_SHA}\`" >> $GITHUB_STEP_SUMMARY
