name: Provision Base Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to provision"
        required: true
        type: choice
        options: ["preview", "production"]

permissions:
  contents: read

jobs:
  provision:
    environment: cherry-base
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || sudo apt update && sudo apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1

      - name: Provision VM
        env:
          CHERRY_AUTH_TOKEN: ${{ secrets.CHERRY_AUTH_TOKEN }}
          ENVIRONMENT: ${{ inputs.environment }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Map GitHub environment name to tfvars file name
          if [ "$ENVIRONMENT" = "production" ]; then
            TF_ENV="prod"
          else
            TF_ENV="$ENVIRONMENT"
          fi

          cd platform/infra/providers/cherry/base
          tofu init
          tofu apply -var-file="env.${TF_ENV}.tfvars" -auto-approve

          # Sync VM host to GitHub environment secret
          VM_HOST=$(tofu output -raw vm_host)
          gh secret set VM_HOST --env "$ENVIRONMENT" --body "$VM_HOST"

          echo "âœ… VM provisioned: $VM_HOST"
          echo "âœ… VM_HOST secret updated for environment: $ENVIRONMENT"

      - name: Deployment summary
        run: |
          echo "## ðŸ—ï¸ Base Infrastructure Provisioned" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**VM Host:** Updated in environment secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- VM is ready for app deployment via deploy workflows" >> $GITHUB_STEP_SUMMARY
          echo "- SSH deploy key must be configured in \`${{ inputs.environment }}\` environment secrets" >> $GITHUB_STEP_SUMMARY
