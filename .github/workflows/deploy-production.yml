name: Deploy (Production)

on:
  workflow_run:
    workflows: ["Build & Test Production"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  packages: write
  actions: read # Required for CI telemetry to fetch job logs

concurrency:
  group: deploy-production-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-image:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: production
    env:
      NEXT_TELEMETRY_DISABLED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image vars
        id: image_vars
        run: |
          # Ensure IMAGE_NAME is lowercase for Docker registry compatibility
          IMAGE_NAME=$(echo "ghcr.io/${{ github.repository }}" | tr '[:upper:]' '[:lower:]')

          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          else
            # Use the SHA from the triggering workflow run, not the current workflow
            IMAGE_TAG="prod-${{ github.event.workflow_run.head_sha }}"
          fi

          # Derive MIGRATOR_IMAGE from IMAGE_NAME + IMAGE_TAG (INV-COUPLED-TAGS-NO-GUESSING)
          MIGRATOR_IMAGE="${IMAGE_NAME}:${IMAGE_TAG}-migrate"

          # Derive scheduler-worker tag (digest resolved after GHCR login)
          SCHEDULER_WORKER_TAG="${IMAGE_NAME}:${IMAGE_TAG}-scheduler-worker"

          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "MIGRATOR_IMAGE=${MIGRATOR_IMAGE}" >> $GITHUB_ENV
          echo "SCHEDULER_WORKER_TAG=${SCHEDULER_WORKER_TAG}" >> $GITHUB_ENV
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Setup SSH deploy key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write key file
          echo "$SSH_DEPLOY_KEY" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Validate key file
          echo "SSH key file size: $(wc -c ~/.ssh/deploy_key)"
          echo "SSH key first line: $(head -1 ~/.ssh/deploy_key)"
          echo "SSH key last line: $(tail -1 ~/.ssh/deploy_key)"

          # Known hosts
          ssh-keyscan -H "$VM_HOST" >> ~/.ssh/known_hosts

          # Test SSH connection with full error capture and keepalive
          echo "Testing SSH connection to $VM_HOST..."
          SSH_DEBUG=${SSH_DEBUG:-0}
          SSH_VERBOSE=""; if [ "$SSH_DEBUG" = "1" ]; then SSH_VERBOSE="-vvv"; fi
          set +e
          OUT=$(ssh $SSH_VERBOSE -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes -o ConnectTimeout=30 -o ServerAliveInterval=10 -o ServerAliveCountMax=6 root@"$VM_HOST" "echo SSH test successful" 2>&1)
          RC=$?
          set -e
          echo "$OUT"
          if [ $RC -ne 0 ]; then
            echo "âŒ SSH failed (rc=$RC)"
            echo "Known hosts:"; tail -n 5 ~/.ssh/known_hosts || true
            exit 1
          fi
          echo "âœ… SSH connection successful"
        env:
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
          VM_HOST: ${{ secrets.VM_HOST }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve scheduler-worker digest
        run: |
          # Pull scheduler-worker image and resolve to digest ref
          # INV: Deploy uses digest ref (ghcr.io/...@sha256:...) not tag
          echo "Pulling scheduler-worker image: ${SCHEDULER_WORKER_TAG}"
          docker pull "${SCHEDULER_WORKER_TAG}"

          # Get digest ref from pulled image
          SCHEDULER_WORKER_IMAGE=$(docker inspect --format='{{index .RepoDigests 0}}' "${SCHEDULER_WORKER_TAG}")

          if [[ -z "$SCHEDULER_WORKER_IMAGE" ]]; then
            echo "âŒ Failed to resolve scheduler-worker digest"
            exit 1
          fi

          echo "âœ… Resolved scheduler-worker digest: ${SCHEDULER_WORKER_IMAGE}"
          echo "SCHEDULER_WORKER_IMAGE=${SCHEDULER_WORKER_IMAGE}" >> $GITHUB_ENV

      - name: Validate DSN secrets
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_SERVICE_URL: ${{ secrets.DATABASE_SERVICE_URL }}
        run: platform/ci/scripts/validate-dsns.sh

      - name: Deploy to Cherry Servers
        env:
          DEPLOY_ENVIRONMENT: production
          APP_ENV: production
          COGNI_REPO_URL: https://github.com/${{ github.repository }}.git
          COGNI_REPO_REF: ${{ github.event.workflow_run.head_sha }}
          GIT_READ_USERNAME: Cogni-1729
          GIT_READ_TOKEN: ${{ secrets.GIT_READ_TOKEN }}
          APP_IMAGE: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          MIGRATOR_IMAGE: ${{ env.MIGRATOR_IMAGE }}
          SCHEDULER_WORKER_IMAGE: ${{ env.SCHEDULER_WORKER_IMAGE }}
          DOMAIN: ${{ secrets.DOMAIN }}
          NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_SERVICE_URL: ${{ secrets.DATABASE_SERVICE_URL }}
          POSTGRES_ROOT_USER: ${{ secrets.POSTGRES_ROOT_USER }}
          POSTGRES_ROOT_PASSWORD: ${{ secrets.POSTGRES_ROOT_PASSWORD }}
          APP_DB_USER: ${{ secrets.APP_DB_USER }}
          APP_DB_PASSWORD: ${{ secrets.APP_DB_PASSWORD }}
          APP_DB_SERVICE_USER: ${{ secrets.APP_DB_SERVICE_USER }}
          APP_DB_SERVICE_PASSWORD: ${{ secrets.APP_DB_SERVICE_PASSWORD }}
          APP_DB_NAME: ${{ secrets.APP_DB_NAME }}
          LITELLM_MASTER_KEY: ${{ secrets.LITELLM_MASTER_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          EVM_RPC_URL: ${{ secrets.EVM_RPC_URL }}
          TEMPORAL_DB_USER: ${{ secrets.TEMPORAL_DB_USER }}
          TEMPORAL_DB_PASSWORD: ${{ secrets.TEMPORAL_DB_PASSWORD }}
          SOURCECRED_GITHUB_TOKEN: ${{ secrets.SOURCECRED_GITHUB_TOKEN }}
          VM_HOST: ${{ secrets.VM_HOST }}
          GHCR_DEPLOY_TOKEN: ${{ secrets.GHCR_DEPLOY_TOKEN }}
          GHCR_USERNAME: Cogni-1729
          GRAFANA_CLOUD_LOKI_URL: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          GRAFANA_CLOUD_LOKI_USER: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          GRAFANA_CLOUD_LOKI_API_KEY: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          METRICS_TOKEN: ${{ secrets.METRICS_TOKEN }}
          PROMETHEUS_REMOTE_WRITE_URL: ${{ secrets.PROMETHEUS_REMOTE_WRITE_URL }}
          PROMETHEUS_USERNAME: ${{ secrets.PROMETHEUS_USERNAME }}
          PROMETHEUS_PASSWORD: ${{ secrets.PROMETHEUS_PASSWORD }}
          PROMETHEUS_QUERY_URL: ${{ secrets.PROMETHEUS_QUERY_URL }}
          PROMETHEUS_READ_USERNAME: ${{ secrets.PROMETHEUS_READ_USERNAME }}
          PROMETHEUS_READ_PASSWORD: ${{ secrets.PROMETHEUS_READ_PASSWORD }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
          SCHEDULER_API_TOKEN: ${{ secrets.SCHEDULER_API_TOKEN }}
          BILLING_INGEST_TOKEN: ${{ secrets.BILLING_INGEST_TOKEN }}
          INTERNAL_OPS_TOKEN: ${{ secrets.INTERNAL_OPS_TOKEN }}
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          OPENCLAW_GITHUB_RW_TOKEN: ${{ secrets.OPENCLAW_GITHUB_RW_TOKEN }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_SERVICE_ACCOUNT_TOKEN: ${{ secrets.GRAFANA_SERVICE_ACCOUNT_TOKEN }}
          GITHUB_REVIEW_APP_ID: ${{ secrets.GITHUB_REVIEW_APP_ID }}
          GITHUB_REVIEW_APP_PRIVATE_KEY_BASE64: ${{ secrets.GITHUB_REVIEW_APP_PRIVATE_KEY_BASE64 }}
          GITHUB_REVIEW_INSTALLATION_ID: ${{ secrets.GITHUB_REVIEW_INSTALLATION_ID }}
          GITHUB_REPOS: ${{ vars.GITHUB_REPOS }}
        run: platform/ci/scripts/deploy.sh

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts-${{ github.run_id }}
          path: ${{ runner.temp }}/deploy-${{ github.run_id }}/
          if-no-files-found: warn
          retention-days: 30

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App Image:** \`${IMAGE_NAME}:${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Scheduler-Worker Image:** \`${SCHEDULER_WORKER_IMAGE}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Domain:** \`${{ secrets.DOMAIN }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.event.workflow_run.head_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ **Main App:** \`${{ secrets.DOMAIN }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- â±ï¸ **Scheduler-Worker:** Temporal worker (digest-pinned)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **Promtail Logging:** Container monitoring active" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”€ **Caddy Proxy:** SSL termination & routing" >> $GITHUB_STEP_SUMMARY

      - name: CI Telemetry
        if: always()
        uses: ./.github/actions/loki-ci-telemetry
        with:
          loki_url: ${{ secrets.GRAFANA_CLOUD_LOKI_URL }}
          loki_user: ${{ secrets.GRAFANA_CLOUD_LOKI_USER }}
          loki_token: ${{ secrets.GRAFANA_CLOUD_LOKI_API_KEY }}
          job_status: ${{ job.status }}
