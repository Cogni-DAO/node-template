name: Deploy (Production)

on:
  workflow_run:
    workflows: ["Build & Test Production"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-production-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-image:
    runs-on: ubuntu-latest
    environment: production
    env:
      NEXT_TELEMETRY_DISABLED: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image vars
        id: image_vars
        run: |
          # Ensure IMAGE_NAME is lowercase for Docker registry compatibility
          IMAGE_NAME=$(echo "ghcr.io/${{ github.repository }}" | tr '[:upper:]' '[:lower:]')

          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          else
            # Use the SHA from the triggering workflow run, not the current workflow
            IMAGE_TAG="prod-${{ github.event.workflow_run.head_sha }}"
          fi

          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Setup SSH deploy key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write key file
          echo "$SSH_DEPLOY_KEY" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Validate key file
          echo "SSH key file size: $(wc -c ~/.ssh/deploy_key)"
          echo "SSH key first line: $(head -1 ~/.ssh/deploy_key)"
          echo "SSH key last line: $(tail -1 ~/.ssh/deploy_key)"

          # Known hosts
          ssh-keyscan -H "$VM_HOST" >> ~/.ssh/known_hosts

          # Test SSH connection
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes -o ConnectTimeout=10 root@"$VM_HOST" "echo 'SSH test successful'" || {
            echo "SSH test failed. Key fingerprint:"
            ssh-keygen -lf ~/.ssh/deploy_key || echo "Could not read key fingerprint"
            exit 1
          }
        env:
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
          VM_HOST: ${{ secrets.VM_HOST }}

      - name: Deploy to Cherry Servers
        env:
          DEPLOY_ENVIRONMENT: production
          APP_ENV: production
          APP_IMAGE: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          DOMAIN: ${{ secrets.DOMAIN }}
          NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          POSTGRES_ROOT_USER: ${{ secrets.POSTGRES_ROOT_USER }}
          POSTGRES_ROOT_PASSWORD: ${{ secrets.POSTGRES_ROOT_PASSWORD }}
          APP_DB_USER: ${{ secrets.APP_DB_USER }}
          APP_DB_PASSWORD: ${{ secrets.APP_DB_PASSWORD }}
          APP_DB_NAME: ${{ secrets.APP_DB_NAME }}
          LITELLM_MASTER_KEY: ${{ secrets.LITELLM_MASTER_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          VM_HOST: ${{ secrets.VM_HOST }}
          GHCR_DEPLOY_TOKEN: ${{ secrets.GHCR_DEPLOY_TOKEN }}
          GHCR_USERNAME: Cogni-1729
        run: platform/ci/scripts/deploy.sh

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts-${{ github.run_id }}
          path: ${{ runner.temp }}/deploy-${{ github.run_id }}/
          if-no-files-found: warn
          retention-days: 30

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${IMAGE_NAME}:${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Domain:** \`${{ secrets.DOMAIN }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.event.workflow_run.head_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ **Main App:** \`${{ secrets.DOMAIN }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **Promtail Logging:** Container monitoring active" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”€ **Caddy Proxy:** SSL termination & routing" >> $GITHUB_STEP_SUMMARY
