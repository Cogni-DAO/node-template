---
id: task.0054.handoff
type: handoff
work_item_id: task.0054
status: active
created: 2026-02-14
updated: 2026-02-14
branch: feat/task.0054-governance-run-foundation
last_commit: 2b9faecf
---

# Handoff: Governance Run Foundation — Repo-Spec Config + Schedule Sync

## Context

- task.0046 seeded `cogni_system` billing account + revenue share. This task enables **governance runs** via declarative repo-spec schedules.
- `.cogni/repo-spec.yaml` declares charter-scoped schedules (COMMUNITY, ENGINEERING, SUSTAINABILITY, GOVERN) with cron + entrypoint.
- A `syncGovernanceSchedules()` function reads repo-spec, ensures Temporal schedules exist for `cogni_system`.
- Schedules send 1-word triggers (`COMMUNITY`, `ENGINEERING`, etc.) to the OpenClaw gateway via the existing `GovernanceScheduledRunWorkflow`.
- As-built spec: [governance-scheduling.md](../../docs/spec/governance-scheduling.md).

## Current State

- **DONE — Checkpoint 1 (config layer):** `pnpm check` passes with all changes below.
  - `.cogni/repo-spec.yaml` has `governance.schedules` array (4 charters)
  - `repoSpec.schema.ts` has `governanceScheduleSchema` + `governanceSpecSchema` (optional, defaults to empty)
  - `repoSpec.server.ts` has `getGovernanceConfig()` accessor (lazy-cached, like `getPaymentConfig()`)
  - `index.ts` barrel exports `GovernanceConfig`, `GovernanceSchedule`, `getGovernanceConfig`
  - 5 new unit tests in `repoSpec.server.test.ts` (all passing)
- **DONE — Checkpoint 2 (sync function):** Written but has one **lint fix needed** before `pnpm check` will pass.
  - `src/features/governance/services/syncGovernanceSchedules.ts` — full sync logic (create/resume/skip/prune)
  - `tests/unit/features/governance/services/syncGovernanceSchedules.spec.ts` — 8 tests, needs unused import removed (line 17: `type ScheduleControlPort`)
- **NOT STARTED:**
  - CLI wrapper script (`src/scripts/governance-schedules-sync.ts`)
  - `deploy.sh` wiring (`pnpm governance:schedules:sync` after migrations)
  - `package.json` script entry
  - AGENTS.md for `src/features/governance/`
  - Doc headers on all touched files
  - Work item update (status → In Progress, branch field)

## Decisions Made

- **No migrations** — governance grant is created on-demand by the `ensureGovernanceGrant` dependency (provided by CLI wrapper), not by a DB migration.
- **Dependency injection via `GovernanceScheduleSyncDeps` interface** — the sync function takes `{ ensureGovernanceGrant, scheduleControl, listGovernanceScheduleIds, log }`. This avoids branded-type issues with `UserId` for system tenant and keeps the function testable.
- **Prune = pause, never delete** — removed schedules are paused (reversible). See `PRUNE_IS_PAUSE` invariant in the sync function.
- **Schedule IDs are deterministic** — `governance:{charter_lowercase}` (e.g., `governance:community`). Helper: `governanceScheduleId()`.
- **Graph ID hardcoded** — `sandbox:openclaw` for all governance runs. The `input.message` field carries the charter-specific trigger word.
- **`ScheduleControlPort` has no `updateSchedule`** — existing schedules are skipped on re-sync. If cron changes, manual delete+recreate needed (or add update support later).

## Next Actions

- [ ] Fix lint error in test file (remove unused `type ScheduleControlPort` import, line 17)
- [ ] Run `pnpm lint:fix && pnpm format && pnpm check` to verify Checkpoint 2 passes
- [ ] Create CLI wrapper: `src/scripts/governance-schedules-sync.ts` (see plan section 6)
  - Wire `ensureGovernanceGrant` with raw SQL INSERT ... ON CONFLICT (serviceDb, BYPASSRLS)
  - Wire `listGovernanceScheduleIds` with Temporal `client.schedule.list()` filtered by `governance:` prefix
  - Wire `scheduleControl` with `TemporalScheduleControlAdapter`
  - Wrap entire call in `pg_advisory_lock(hashtext('governance_sync'))` for single-writer
- [ ] Add `"governance:schedules:sync"` script to `package.json`
- [ ] Add `pnpm governance:schedules:sync` to `platform/ci/scripts/deploy.sh` (after migrations, before stack up)
- [ ] Create `src/features/governance/AGENTS.md`
- [ ] Update doc headers on all touched files
- [ ] Update work item: set `status: In Progress`, `branch: feat/task.0054-governance-run-foundation`, `updated: 2026-02-15`
- [ ] Run final `pnpm check` and recommend `/review-implementation`

## Risks / Gotchas

- **Branded type mismatch**: `SYSTEM_TENANT_PRINCIPAL_ID` is `"cogni_system_principal"` (not UUID v4). The `ExecutionGrantUserPort.createGrant` requires `UserId` (branded UUID). The CLI wrapper should use raw SQL for grant creation, NOT the port.
- **`SYSTEM_ACTOR`** from `@cogni/ids/system` is `00000000-0000-4000-a000-000000000000` — use this for `withTenantScope` actorId in the CLI wrapper.
- **No `listSchedules` on `ScheduleControlPort`** — the `listGovernanceScheduleIds` dep must use the Temporal client directly (`client.schedule.list()`). The port only has create/pause/resume/delete/describe.
- **dep-cruiser**: `src/features/governance/` can import from `@cogni/scheduler-core` (package), `@shared/config` (shared layer). No special config needed.
- **All changes are uncommitted** on branch `feat/task.0054-governance-run-foundation`. Nothing has been committed yet — the branch was created from `staging` at `2b9faecf`.

## Pointers

| File / Resource                                                           | Why it matters                                                            |
| ------------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| `work/items/task.0054.governance-run-foundation.md`                       | Work item with requirements and allowed changes                           |
| `.cogni/repo-spec.yaml` (governance section)                              | Source of truth for schedule definitions                                  |
| `src/shared/config/repoSpec.schema.ts`                                    | Zod schemas (`governanceScheduleSchema`, `governanceSpecSchema`)          |
| `src/shared/config/repoSpec.server.ts`                                    | `getGovernanceConfig()` accessor                                          |
| `src/features/governance/services/syncGovernanceSchedules.ts`             | Core sync logic + `GovernanceScheduleSyncDeps` interface                  |
| `tests/unit/features/governance/services/syncGovernanceSchedules.spec.ts` | 8 mock tests for sync function                                            |
| `src/adapters/server/temporal/schedule-control.adapter.ts`                | Temporal implementation of `ScheduleControlPort`                          |
| `packages/scheduler-core/src/ports/schedule-control.port.ts`              | `ScheduleControlPort` interface + error types                             |
| `packages/db-client/src/adapters/drizzle-grant.adapter.ts`                | Grant adapter pattern (reference for CLI wrapper grant logic)             |
| `src/shared/constants/system-tenant.ts`                                   | `SYSTEM_TENANT_ID`, `SYSTEM_TENANT_PRINCIPAL_ID` constants                |
| `platform/ci/scripts/deploy.sh`                                           | Deploy script — add `governance:schedules:sync` after Step 9 (migrations) |
