---
id: task.0054.handoff
type: handoff
work_item_id: task.0054
status: active
created: 2026-02-14
updated: 2026-02-15
branch: feat/task.0054-governance-run-foundation
last_commit: 697e3902
---

# Handoff: Governance Run Foundation — Checkpoint 3 (In Progress)

## Context

- task.0046 seeded `cogni_system` billing account. This task adds declarative governance **runs** — repo-spec schedules synced to Temporal at deploy time.
- Checkpoints 1-2 (config layer + sync function) are done and committed.
- Checkpoint 3 (job module, CLI, deploy wiring, port extensions) is **partially implemented but not committed**. All changes are in the working tree.
- As-built spec: [governance-scheduling.md](../../docs/spec/governance-scheduling.md).
- Work item: [task.0054](../items/task.0054.governance-run-foundation.md).

## Current State

- **DONE (committed):** Config layer, sync function, unit tests (8 passing).
- **DONE (uncommitted, working tree):**
  - `src/shared/env/server-env.ts` — env validation logic extracted from `server.ts` so bootstrap/jobs can run under plain Node (no `server-only`)
  - `src/shared/env/server.ts` — now a thin `import "server-only"; export * from "./server-env"` re-export
  - `src/bootstrap/container.ts` — imports `serverEnv` from `server-env.ts` directly
  - `packages/scheduler-core/src/ports/schedule-control.port.ts` — added `listScheduleIds(prefix: string)`
  - `src/adapters/server/temporal/schedule-control.adapter.ts` — implemented `listScheduleIds` via `client.schedule.list()`
  - `packages/scheduler-core/src/ports/execution-grant.port.ts` — added `ensureGrant` to `ExecutionGrantUserPort`
  - `packages/db-client/src/adapters/drizzle-grant.adapter.ts` — implemented `ensureGrant` (find-or-create, no raw SQL)
  - `packages/scheduler-core/src/services/syncGovernanceSchedules.ts` — **canonical sync function moved here** from features (pure orchestration, no `@/` imports)
  - `src/features/governance/services/syncGovernanceSchedules.ts` — now re-exports from `@cogni/scheduler-core`
  - `src/bootstrap/jobs/syncGovernanceSchedules.job.ts` — job module (advisory lock + container wiring)
  - `src/scripts/governance-schedules-sync.ts` — CLI entry point (zero logic)
  - `package.json` — `governance:schedules:sync` script added
  - `platform/ci/scripts/deploy.sh` — Step 10.1 governance sync wired after stack-up
  - `.dependency-cruiser.cjs` — `scripts` layer added, job file exempted from service-db + internal-adapter rules
  - `src/features/governance/AGENTS.md` — created

- **FAILING (`pnpm check`):**
  - `check:docs` — AGENTS.md was fixed (Status + Notes heading) but may still have issues
  - `arch:check` — was failing because bootstrap→features; **fixed** by moving sync function to `scheduler-core` and making features file a re-export. Needs re-verification.
  - `lint` / `format` / `test:contract` — unknown if pre-existing or new; need investigation

## Decisions Made

- **`server-only` isolation:** Logic extracted to `server-env.ts`; barrel keeps re-exporting from `server.ts` (guard preserved for Next.js). Only `container.ts` and job module import `server-env.ts` directly.
- **Sync function lives in `@cogni/scheduler-core`** (not features) — it's pure orchestration depending only on ports/types. Bootstrap imports from the package, not features. Features re-exports for backward compat.
- **`ensureGrant` on port, not raw SQL** — find-or-create via ORM in `DrizzleExecutionGrantUserAdapter`. Advisory lock at job level prevents races.
- **`listScheduleIds` on `ScheduleControlPort`** — proper port method, not a Temporal-client leak.
- **PRUNE_IS_PAUSE** — removed schedules are paused, never deleted.

## Next Actions

- [ ] Rebuild packages (`pnpm packages:build`) — types for new port methods
- [ ] Run `pnpm check` and fix any remaining failures (lint, format, test, docs, arch)
- [ ] Verify `GovernanceScheduleConfig` type in scheduler-core is structurally compatible with `GovernanceConfig` from `@/shared/config` (the job passes `getGovernanceConfig()` result to `syncGovernanceSchedules()`)
- [ ] Check if test file needs updating — imports from features re-export, should still work
- [ ] Consider moving tests to `packages/scheduler-core/tests/` or `tests/packages/scheduler-core/`
- [ ] Commit all changes, run final `pnpm check`
- [ ] Update work item status

## Risks / Gotchas

- **Package rebuild required:** Port changes in `scheduler-core` and `db-client` require `pnpm packages:build` before typecheck passes.
- **`env/index.ts` barrel:** Must keep re-exporting from `./server` (not `./server-env`) to preserve the `server-only` guard for Next.js routes.
- **dep-cruiser `scripts` layer:** Newly added — only allows `scripts → bootstrap`. If more script deps arise, update the allowed rule.
- **`sql` template tag:** Job module uses `sql` from `drizzle-orm` for advisory lock queries (not raw strings).
- **Pre-existing failures:** `lint`, `format`, `test:contract` were also failing — may not be caused by this work.

## Pointers

| File / Resource                                                           | Why it matters                                   |
| ------------------------------------------------------------------------- | ------------------------------------------------ |
| `work/items/task.0054.governance-run-foundation.md`                       | Work item with requirements                      |
| `packages/scheduler-core/src/services/syncGovernanceSchedules.ts`         | **Canonical** sync function (pure orchestration) |
| `packages/scheduler-core/src/ports/schedule-control.port.ts`              | `listScheduleIds` added here                     |
| `packages/scheduler-core/src/ports/execution-grant.port.ts`               | `ensureGrant` added here                         |
| `packages/db-client/src/adapters/drizzle-grant.adapter.ts`                | `ensureGrant` implementation                     |
| `src/shared/env/server-env.ts`                                            | Extracted env logic (no `server-only`)           |
| `src/bootstrap/jobs/syncGovernanceSchedules.job.ts`                       | Job module (advisory lock + wiring)              |
| `src/scripts/governance-schedules-sync.ts`                                | CLI entry point                                  |
| `.dependency-cruiser.cjs`                                                 | Layer rules (`scripts`, job exemptions)          |
| `platform/ci/scripts/deploy.sh`                                           | Step 10.1 governance sync                        |
| `tests/unit/features/governance/services/syncGovernanceSchedules.spec.ts` | 8 unit tests (may need path update)              |
