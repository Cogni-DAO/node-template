---
id: task.0029.handoff
type: handoff
work_item_id: task.0029
status: active
created: 2026-02-12
updated: 2026-02-13
branch: feat/billing-callback-fix
last_commit: 2d321591
---

# Handoff: Kill proxy billing path — callback is the sole cost oracle

## Context

- **task.0029** shipped a LiteLLM `generic_api` callback ingest endpoint on `feat/billing-callback-fix`. The callback writes `charge_receipts` with real cost data for all executor types.
- **Duplicate receipt bug:** Gateway calls produce TWO receipts — $0 from `ProxyBillingReader` (synchronous audit log) and real-cost from callback (async). Different `source_reference` keys prevent idempotency dedup.
- **This cleanup** deletes the entire proxy audit log billing path and adds a safety net in `commitUsageFact()` so paid models without cost data never write $0 receipts (callback provides real cost).
- All cleanup changes are **unstaged on `feat/billing-callback-fix`**. No new branch was created.

## Current State

- **Unstaged changes (16 files):**
  - Deleted `ProxyBillingReader` class and its barrel export
  - Removed proxy billing block from `SandboxGraphProvider.runGateway()`, `billingReader` constructor param
  - Deleted dead `recordBilling()` + `BillingContext` from `billing.ts`
  - Added `NO_ZERO_RECEIPTS_FOR_PAID_MODELS` safety net: `source === "litellm"` + missing cost → `log.debug` + early return. Non-litellm sources keep hard error.
  - Removed `OPENCLAW_BILLING_DIR` from env schema, factory, both docker-compose files (app env + app volume + proxy volume + named volume definition)
  - Updated invariants in `billing.ts` header and `billing-ingest.md` spec
  - Updated stale comment in ingest route, AGENTS.md files (sandbox, features/ai)
  - Updated stack tests: removed `ProxyBillingReader` usage, tightened `completion-billing` assertions (litellm_call_id uniqueness, no $0 for paid)
  - New unit test: `tests/unit/features/ai/billing-no-zero-receipts.spec.ts` (4 cases)
- **Verified locally:** `pnpm typecheck` passes, unit tests pass
- **NOT done:** Commit, `pnpm check`, `pnpm test:contract`, push, PR, E2E verification

## Decisions Made

1. **NO_ZERO_RECEIPTS_FOR_PAID_MODELS** — scoped to `source === "litellm"` (callback-backed). Non-litellm sources still write $0 + ERROR log. See `billing.ts:115-129`.
2. **`log.debug` not `log.warn`** for the deferral — this is the expected path for every gateway call; warn would be log spam. Metric counter is the right alerting mechanism.
3. **Full volume cleanup** — removed billing volume from app AND proxy. Nginx writes to ephemeral overlay FS (nobody reads). No nginx config changes.
4. **`extractModelId` test helper** rewritten: `docker exec` on proxy container instead of host FS read.
5. **`recordBilling()` deleted** — zero live callers, `completion.ts:41` already has removal comment. `BillingContext` interface and `GraphId` import removed with it.

## Next Actions

- [ ] Run `pnpm check` (full lint + type + format validation)
- [ ] Run `pnpm test:contract` — verify contract tests pass with changes
- [ ] Stage and commit all changes (conventional commit: `fix(billing): kill proxy billing path, add NO_ZERO_RECEIPTS_FOR_PAID_MODELS`)
- [ ] Push `feat/billing-callback-fix` and create PR against `staging`
- [ ] E2E: start `dev:stack`, run gateway call, verify exactly ONE receipt with cost > 0
- [ ] Merge PR

## Risks / Gotchas

- **Silent callback failure = no receipt.** If LiteLLM `generic_api` callback fails, paid calls have ZERO receipts (not $0). Reconciler (task.0039) is the planned safety net but not yet built. Monitor `commitUsageFact` debug logs for deferral volume.
- **Docker volume orphans.** Existing deployments have `openclaw_billing` named volume. Needs `docker volume prune` or manual cleanup on deploy.
- **`ProxyBillingEntry` type stays.** Still used by ephemeral sandbox path (`LlmProxyManager.stop()` → `parseAuditLog`). Do not delete from `src/ports/sandbox-runner.port.ts`.
- **`completion.ts:41,169`** still reference `recordBilling` in stale comments. Harmless, optional cleanup.

## Pointers

| File / Resource                                                     | Why it matters                                              |
| ------------------------------------------------------------------- | ----------------------------------------------------------- |
| `src/features/ai/services/billing.ts`                               | `commitUsageFact()` — scoped early-return at lines 115-129  |
| `src/adapters/server/sandbox/sandbox-graph.provider.ts`             | Gateway path — proxy billing block removed                  |
| `docs/spec/billing-ingest.md`                                       | Invariants table — `NO_ZERO_RECEIPTS_FOR_PAID_MODELS` added |
| `src/bootstrap/graph-executor.factory.ts`                           | Factory — `billingReader` + `OPENCLAW_BILLING_DIR` removed  |
| `tests/unit/features/ai/billing-no-zero-receipts.spec.ts`           | 4 unit tests proving the invariant                          |
| `work/items/task.0029.callback-driven-billing-kill-log-scraping.md` | Parent work item                                            |
| `docs/spec/billing-ingest.md#design`                                | Full callback architecture diagram                          |
