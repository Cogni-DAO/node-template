---
id: task.0029.handoff
type: handoff
work_item_id: task.0029
status: active
created: 2026-02-12
updated: 2026-02-13
branch: fix/kill-proxy-billing-path
last_commit: 2d321591
---

# Handoff: Kill proxy billing path — trust LiteLLM callback unequivocally

## Context

- **task.0029 deferred steps 5+6:** PR #399 (`feat/billing-callback-fix`) shipped the LiteLLM `generic_api` callback ingest endpoint. The callback works. Now we're deleting the old proxy audit log billing path that produced $0 receipts.
- **Duplicate receipts bug:** With callback working, gateway calls produce TWO receipts — one $0 from `ProxyBillingReader` (synchronous, audit log), one with real cost from callback (async). Different `source_reference` values prevent idempotency dedup.
- **Branch `fix/kill-proxy-billing-path`** off `feat/billing-callback-fix`. All code changes are made but NOT yet committed.

## Current State

- **Done (unstaged):**
  - Deleted `ProxyBillingReader` class (`src/adapters/server/sandbox/proxy-billing-reader.ts`)
  - Removed proxy billing block from `SandboxGraphProvider.runGateway()` (lines 529-567)
  - Removed `billingReader` constructor param from `SandboxGraphProvider`
  - Deleted dead `recordBilling()` function from `billing.ts` (zero callers)
  - Added scoped safety net in `commitUsageFact()`: paid model + missing cost + `source === "litellm"` → early return (no receipt). Non-litellm sources keep ERROR.
  - Removed `OPENCLAW_BILLING_DIR` from: env schema (`server.ts`), factory (`graph-executor.factory.ts`), both docker-compose files (app + proxy volume mounts + named volume)
  - Updated invariants in `billing.ts` header and `docs/spec/billing-ingest.md`
  - Updated stale comment in `route.ts` (ingest endpoint)
  - Updated `AGENTS.md` files (sandbox, features/ai)
  - Updated tests: gateway-billing-callback, sandbox-openclaw, completion-billing
  - Created unit test: `tests/unit/features/ai/billing-no-zero-receipts.spec.ts` (4 tests, all passing)
- **Verified:** `pnpm typecheck` passes, `pnpm check:docs` passes, unit tests pass
- **NOT done:** Commit, push, PR creation, E2E verification with live stack

## Decisions Made

1. **NO_ZERO_RECEIPTS_FOR_PAID_MODELS** — new invariant. Scoped to `source === "litellm"` only (callback-backed). Non-litellm sources still write $0 receipts (no callback recovery). See `billing.ts:115-129`.
2. **ZERO_CREDIT_RECEIPTS_WRITTEN kept** but scoped — applies to free models only now. Not deleted.
3. **Full volume cleanup** — removed billing volume from both app AND proxy containers. Nginx still writes to `/billing/` inside its overlay FS (ephemeral, nobody reads it). No nginx config changes needed.
4. **`extractModelId` test helper** rewritten to use `docker exec` on proxy container instead of host filesystem read (since billing volume mount removed).

## Next Actions

- [ ] Stage all changes and commit on `fix/kill-proxy-billing-path`
- [ ] Push and create PR against `staging` (or merge into `feat/billing-callback-fix` PR #399)
- [ ] Run E2E test: gateway call → verify exactly ONE receipt with cost > 0, no $0 duplicate
- [ ] Run `pnpm test:contract` to verify contract tests pass
- [ ] Merge PR #399 (includes both callback endpoint + this cleanup)

## Risks / Gotchas

- **If LiteLLM callback fails silently**, paid calls will have NO receipt (not $0). Reconciler (task.0039) is the safety net but is not yet built. Monitor `billing.deferred_missing_cost_total` warn logs.
- **`sandbox-openclaw.stack.test.ts`** "billing entries" test was removed (tested deleted infrastructure). The "provider model override" test now uses `docker exec` — requires proxy container running.
- **Docker volume orphans:** Existing deployments may have `openclaw_billing` named volume. `docker volume prune` or manual cleanup needed on deploy.

## Pointers

| File / Resource                                                     | Why it matters                                              |
| ------------------------------------------------------------------- | ----------------------------------------------------------- |
| `src/features/ai/services/billing.ts`                               | `commitUsageFact()` — scoped early-return at line 115-129   |
| `src/adapters/server/sandbox/sandbox-graph.provider.ts`             | Gateway path — proxy billing block removed                  |
| `docs/spec/billing-ingest.md`                                       | Invariants table — `NO_ZERO_RECEIPTS_FOR_PAID_MODELS` added |
| `src/bootstrap/graph-executor.factory.ts`                           | Factory — `billingReader` + `OPENCLAW_BILLING_DIR` removed  |
| `tests/unit/features/ai/billing-no-zero-receipts.spec.ts`           | 4 unit tests proving the invariant                          |
| `work/items/task.0029.callback-driven-billing-kill-log-scraping.md` | Parent work item (deferred steps 5+6)                       |
| PR #399                                                             | `feat/billing-callback-fix` — base branch                   |
