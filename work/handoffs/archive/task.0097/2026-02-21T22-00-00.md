---
id: handoff.ingestion-core-github-adapter
type: handoff
title: "@cogni/ingestion-core + GitHub Source Adapter"
created: 2026-02-21
branch: worktree-ingestion-core-github-adapter
worktree: .claude/worktrees/ingestion-core-github-adapter
task_refs: task.0097
project: proj.transparent-credit-payouts
---

# Handoff: @cogni/ingestion-core + GitHub Adapter

## What's Done

### New package: `packages/ingestion-core/`

- `src/model.ts` — `ActivityEvent`, `StreamDefinition`, `StreamCursor`, `CollectParams`, `CollectResult`
- `src/port.ts` — `SourceAdapter` interface
- `src/helpers.ts` — `buildEventId()`, `canonicalJson()`, `hashCanonicalPayload()`
- `src/index.ts` — barrel
- `AGENTS.md`, `.gitignore`, `__arch_probes__/`, package.json/tsconfig/tsup scaffolding
- Root wired: `package.json`, `tsconfig.json`, `biome/base.json` all updated
- `pnpm packages:build` passes, `packages:validate` shows 11/11

### GitHub adapter: `services/scheduler-worker/src/adapters/ingestion/github.ts`

- `GitHubSourceAdapter implements SourceAdapter`
- 3 streams: `pull_requests`, `reviews`, `issues` via GraphQL
- Deterministic IDs: `github:pr:owner/repo:42`, `github:review:...`, `github:issue:...`
- Payload hashing via `hashCanonicalPayload()` (Web Crypto SHA-256)
- Bot filtering, pagination, rate limit handling (`GitHubRateLimitError`)
- Config injected (no process.env): `GitHubAdapterConfig { token, repos }`

### Wiring

- `services/scheduler-worker/package.json` — added `@cogni/ingestion-core`, `@octokit/graphql`
- `services/scheduler-worker/src/config.ts` — added optional `GITHUB_TOKEN`, `GITHUB_REPOS`
- `src/ports/source-adapter.port.ts` — re-exports from `@cogni/ingestion-core`
- `src/ports/index.ts` — updated

### Tests

- `packages/ingestion-core/tests/helpers.test.ts` — 13 tests, all pass
- `services/scheduler-worker/tests/github-adapter.test.ts` — 22 tests, all pass
- `services/scheduler-worker/tests/fixtures/github-graphql.fixtures.ts` — mock data

## What Remains

1. **`pnpm check` not fully green** — lint/format were auto-fixed but `check:docs` had header issues (mostly fixed, may need one more pass). Run `pnpm check` and fix any remaining.
2. **Scheduler-worker build** — confirmed working (`pnpm --filter @cogni/scheduler-worker-service build`)
3. **arch:check** — passes clean (0 violations)

## Key Files

| File                                                         | What                                    |
| ------------------------------------------------------------ | --------------------------------------- |
| `packages/ingestion-core/src/`                               | Pure types + helpers                    |
| `services/scheduler-worker/src/adapters/ingestion/github.ts` | GitHub adapter                          |
| `services/scheduler-worker/tests/github-adapter.test.ts`     | Adapter tests                           |
| `docs/guides/new-packages.md`                                | Checklist followed for package creation |
| `/Users/derek/.claude/plans/swift-weaving-hammock.md`        | Full implementation plan                |

## Depends On

- **task.0094** (another dev) — DB schema (`activity_events`, `source_cursors`, `activity_curation`, epochs columns), `ActivityLedgerStore` port + Drizzle adapter. Merge with that branch when ready.

## Next Steps

- Merge with task.0094 branch when schema lands
- Discord adapter (same `SourceAdapter` interface)
- `CollectEpochWorkflow` Temporal workflow (task.0095) — calls `adapter.collect()`, inserts via `ActivityLedgerStore`
