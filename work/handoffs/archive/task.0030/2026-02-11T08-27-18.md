---
id: task.0030.handoff
type: handoff
work_item_id: task.0030
status: active
created: 2026-02-11
updated: 2026-02-11
branch: fix/openclaw-billing-clean
last_commit: d2b7bf2b
---

# Handoff: Thread Persistence P0

## Context

- The platform has **no server-side message persistence** — the client sends full conversation history on every request, allowing fabrication of assistant/tool messages
- We need server-authoritative persistence using AI SDK `UIMessage[]` per thread, stored in a new `ai_threads` table with Postgres RLS
- The canonical spec is [`docs/spec/thread-persistence.md`](../../docs/spec/thread-persistence.md) — all invariants, schema, port interface, and acceptance checks live there
- P0 is **backend-only** — the existing client transport (`useDataStreamRuntime`, sending `messages[]`) is unchanged; the server extracts the last user message and ignores client-supplied history
- No implementation code exists yet — only spec, project, and research artifacts

## Current State

- **Done:** Spec finalized with invariants (STATE_KEY_LIFECYCLE, SERIALIZED_APPENDS, CLIENT_SENDS_USER_ONLY, etc.), schema (`ai_threads` with `owner_user_id` + `state_key` columns), port interface, and acceptance checks
- **Done:** Project roadmap at [`work/projects/proj.thread-persistence.md`](../projects/proj.thread-persistence.md) — P0/P1/P2 phases
- **Done:** Research at [`docs/research/ai-sdk-transcript-authority-analysis.md`](../../docs/research/ai-sdk-transcript-authority-analysis.md) — AI SDK 5/6 patterns, AiEvent mapping rationale
- **Not started:** All P0 deliverables — see task checklist at [`work/items/task.0030.thread-persistence-p0.md`](../items/task.0030.thread-persistence-p0.md)
- **Not started:** `ai` package (AI SDK 5+) not yet added as a dependency

## Decisions Made

- **UIMessage[] JSONB per thread** — not normalized rows, not `run_artifacts`. See [spec: Key Decision 1](../../docs/spec/thread-persistence.md#1-uimessage-jsonb-vs-normalized-message-rows)
- **AiEvent stays internal** — bridged at route layer. See [spec: Key Decision 2](../../docs/spec/thread-persistence.md#2-aievent-stays-internal)
- **P0 wire format: KEEP `createAssistantStreamResponse`** — no wire protocol change. UIMessage accumulator runs in parallel for persistence only. `createUIMessageStream()` deferred to P1. See [spec: Key Decision 3](../../docs/spec/thread-persistence.md#3-p0-wire-format-keep-assistant-stream)
- **P0 message conversion: KEEP `toCoreMessages()`** — add `uiMessagesToMessageDtos()` mapper. `convertToModelMessages()` deferred to P1. See [spec: Key Decision 4](../../docs/spec/thread-persistence.md#4-p0-message-conversion-preserve-existing-pipeline)
- **`stateKey` is the only client-visible thread identifier** — scoped per-tenant via `UNIQUE(owner_user_id, state_key)`. No composite keys.
- **`owner_user_id`** is the canonical tenant scope (authenticated user ID, not billing account)
- **`SELECT ... FOR UPDATE`** in adapter transaction prevents lost updates on concurrent JSONB writes (SERIALIZED_APPENDS invariant)
- **stateKey lifecycle:** server generates `nanoid(21)` if absent, validates `^[a-zA-Z0-9_-]{1,128}$` (breaking: removes `.` and `:`), returns via `X-State-Key` header
- **MAX_THREAD_MESSAGES = 200** — adapter rejects saves exceeding this limit to prevent unbounded JSONB growth
- **Minimal accumulator** — route builds response `UIMessage` from AiEvent stream (~30 lines), runs alongside existing assistant-stream controller
- **No facade changes** — route pre-processes messages (load thread, append user msg) before calling the completion facade

## Next Actions

- [ ] Add `ai` package (AI SDK 5+) + `nanoid` — `UIMessage` types, `createIdGenerator()`, stateKey generation
- [ ] Create `ai_threads` Drizzle schema + RLS + migration
- [ ] Create `ThreadPersistencePort` + `DrizzleThreadPersistenceAdapter` (FOR UPDATE + MESSAGES_GROW_ONLY + MAX_THREAD_MESSAGES)
- [ ] Update contract stateKey validation pattern in `ai.chat.v1.contract.ts` (breaking: removes `.` and `:`)
- [ ] Add `uiMessagesToMessageDtos()` mapper in `src/features/ai/services/mappers.ts`
- [ ] Refactor route: extract last user message → load thread → append → map via `uiMessagesToMessageDtos()` → existing `toCoreMessages()` → execute → accumulate UIMessage → persist
- [ ] Add AiEvent→UIMessage accumulator in route — parallel to existing `createAssistantStreamResponse` (no wire format change)
- [ ] Add PII masking utility applied before `saveThread()`
- [ ] Write stack tests per spec § Acceptance Checks (all 8 checks)

## Risks / Gotchas

- **P0 does NOT use `convertToModelMessages()`** — that's P1. P0 adds `uiMessagesToMessageDtos()` to convert `UIMessage[]` → `MessageDto[]`, then feeds through existing `toCoreMessages()`. The facade is unchanged.
- **P0 does NOT change the wire format** — keep `createAssistantStreamResponse` (assistant-stream). The UIMessage accumulator runs in parallel for persistence only. `createUIMessageStream()` is P1.
- The route currently uses `crypto.randomUUID()` for stateKey generation (line ~366) — switch to `nanoid(21)` and tighten the validation regex
- Persistence MUST happen after pump completes (`RunEventRelay.startPump()`), not during streaming — same timing guarantee billing depends on
- The existing `toMessageDtos()` / `toCoreMessages()` pipeline in the route stays — the new `uiMessagesToMessageDtos()` mapper feeds INTO this pipeline; don't refactor both at once
- stateKey validation tightening removes `.` and `:` — update any tests using these characters in stateKeys

## Pointers

| File / Resource                                                                                                        | Why it matters                                                                                      |
| ---------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------- |
| [`docs/spec/thread-persistence.md`](../../docs/spec/thread-persistence.md)                                             | Canonical spec — invariants, schema, port interface, acceptance checks                              |
| [`work/items/task.0030.thread-persistence-p0.md`](../items/task.0030.thread-persistence-p0.md)                         | P0 task with full deliverable checklist                                                             |
| [`src/app/api/v1/ai/chat/route.ts`](../../src/app/api/v1/ai/chat/route.ts)                                             | Chat route — primary refactor target (load→execute→persist flow)                                    |
| [`src/contracts/ai.chat.v1.contract.ts`](../../src/contracts/ai.chat.v1.contract.ts)                                   | Contract — stateKey validation needs pattern update                                                 |
| [`src/app/_facades/ai/completion.server.ts`](../../src/app/_facades/ai/completion.server.ts)                           | Completion facade — NO changes needed, route pre-processes                                          |
| [`src/features/ai/services/mappers.ts`](../../src/features/ai/services/mappers.ts)                                     | `toCoreMessages()` stays as-is; add `uiMessagesToMessageDtos()` mapper (UIMessage[] → MessageDto[]) |
| [`packages/db-client/src/tenant-scope.ts`](../../packages/db-client/src/tenant-scope.ts)                               | RLS helper — reuse `setTenantContext()` in adapter                                                  |
| [`packages/ai-core/src/events/ai-events.ts`](../../packages/ai-core/src/events/ai-events.ts)                           | AiEvent types — accumulator maps these to UIMessage parts                                           |
| [`docs/research/ai-sdk-transcript-authority-analysis.md`](../../docs/research/ai-sdk-transcript-authority-analysis.md) | Research: AI SDK patterns, event mapping rationale                                                  |
