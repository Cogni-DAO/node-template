---
id: proj.transparent-credit-payouts
type: handoff
work_item_id: proj.transparent-credit-payouts
status: active
created: 2026-02-20
updated: 2026-02-20
branch: feat/ledger-v0
last_commit: 8f4bfffc
---

# Handoff: Epoch Ledger — Auditable Decision Ledger for Credit Payouts

## Context

- CogniDAO needs transparent, verifiable credit payouts to replace SourceCred's opaque grain scoring
- The system is a **cryptographically auditable decision ledger for human judgment** — NOT an algorithmic valuation engine
- Receipts record who approved what work, how much they valued it, under which policy, with wallet-signed EIP-191 signatures
- Epoch close computes deterministic payouts from approved receipts + pool components — anyone can recompute and verify
- The prior design (spike.0082) had algorithmic valuation (`estimate × role split`); this was rejected as "fake objectivity"

## Current State

- **Done**: Project file redesigned (`work/projects/proj.transparent-credit-payouts.md`), spec written (`docs/spec/epoch-ledger.md`)
- **Done**: Design spike research doc at `docs/research/transparency-log-receipt-design.md` (reference only — superseded by spec)
- **Not started**: All implementation — DB schema, core domain, Temporal workflows, API routes, tests
- **Branch**: `feat/ledger-v0` exists but has no implementation commits yet
- **User edit**: `subject_id` changed from wallet address to `user_id` (UUID) — see [identity spec](../../docs/spec/decentralized-identity.md)

## Decisions Made

- **No server private keys** — issuer wallets sign receipts client-side, server verifies via `viem` ([spec: Receipt Signing](../../docs/spec/epoch-ledger.md#receipt-signing))
- **Auth = SIWE + `ledger_issuers` with role flags** (`can_issue`, `can_approve`, `can_close_epoch`) — separation of authority without full RBAC ([spec: Auth Model](../../docs/spec/epoch-ledger.md#auth-model))
- **Signatures are domain-bound** — canonical message includes `chain_id`, `app_domain`, `spec_version` to prevent cross-context replay ([spec: Receipt Signing](../../docs/spec/epoch-ledger.md#receipt-signing))
- **Pool components pre-recorded** — recorded during epoch via own workflow; close reads by reference, never creates budget; `base_issuance` required ([spec: Pool Model](../../docs/spec/epoch-ledger.md#pool-model))
- **Receipts are immutable facts** — no status column; lifecycle via append-only `receipt_events` table ([spec: Receipt Lifecycle](../../docs/spec/epoch-ledger.md#receipt-lifecycle))
- **Writes via Temporal** — Next.js returns 202, existing `scheduler-worker` executes mutations ([spec: Temporal Workflows](../../docs/spec/epoch-ledger.md#temporal-workflows))
- **Pool = sum of components** — `base_issuance` + `kpi_bonus` + `top_up`, each with pinned algorithm/inputs ([spec: Pool Model](../../docs/spec/epoch-ledger.md#pool-model))
- **Policy pinned reproducibly** — `{repo, commit_sha, path, content_hash}` stored in epoch row
- **Statement unsigned in V0** — derived artifact; DAO multisig signing deferred to P1

## Next Actions

- [ ] Create task work items for implementation (use `/task` to decompose)
- [ ] DB schema: 6 tables in `packages/db-schema/src/ledger.ts` + barrel export + migration
- [ ] Core domain: `src/core/ledger/` — model, rules (BIGINT payout math, largest-remainder), signing (verify only), errors
- [ ] Port: `src/ports/ledger-store.port.ts` — single `LedgerStore` interface
- [ ] Adapter: `src/adapters/server/ledger/drizzle-ledger.ts` — implements `LedgerStore`
- [ ] Temporal: 4 workflows + activities in `services/scheduler-worker/src/` (open epoch, issue receipt, receipt event, close epoch)
- [ ] Contracts: 7 Zod files in `src/contracts/ledger.*.v1.contract.ts`
- [ ] API routes: 4 write (→ Temporal 202) + 4 read (→ direct DB) under `src/app/api/v1/ledger/`
- [ ] DB triggers: append-only enforcement on `work_receipts` and `receipt_events`
- [ ] Tests: unit (core rules), stack (full pipeline with Temporal)

## Risks / Gotchas

- **`subject_id` is `user_id`** (UUID), not wallet address — the user changed this post-design; ensure identity spec alignment
- Temporal workflows must use **deterministic workflow IDs** for idempotency (e.g. `ledger-receipt-{idempotencyKey}`)
- `CloseEpochWorkflow` must be idempotent — closing a closed epoch returns existing statement, no error
- Append-only triggers require custom SQL migration (not expressible in Drizzle schema)
- Existing `scheduler-worker` uses `@cogni/db-client` for DB access — ledger activities need the same pattern

## Pointers

| File / Resource                                                     | Why it matters                                                           |
| ------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| `docs/spec/epoch-ledger.md`                                         | V0 spec: 14 invariants, 6 tables, API, Temporal workflows                |
| `work/projects/proj.transparent-credit-payouts.md`                  | Project roadmap with Crawl/Walk/Run phases                               |
| `docs/research/transparency-log-receipt-design.md`                  | Original design research (reference — some decisions superseded)         |
| `packages/db-schema/src/billing.ts`                                 | Pattern to follow: BIGINT, `.enableRLS()`, idempotency indexes           |
| `services/scheduler-worker/src/workflows/scheduled-run.workflow.ts` | Existing Temporal workflow pattern to replicate                          |
| `services/scheduler-worker/src/activities/index.ts`                 | Activity injection pattern (`createActivities(deps)`)                    |
| `src/lib/auth/server.ts`                                            | SIWE session resolver (`getServerSessionUser()` → `{id, walletAddress}`) |
| `src/core/payments/errors.ts`                                       | Error class pattern to replicate for ledger errors                       |
| `docs/spec/decentralized-identity.md`                               | Identity spec — `subject_id` is `user_id`, not wallet address            |
