---
id: proj.transparent-credit-payouts
type: handoff
work_item_id: proj.transparent-credit-payouts
status: archived
created: 2026-02-20
updated: 2026-02-20
branch: feat/ledger-v0
last_commit: c3c6ee23
---

# Handoff: Epoch Ledger — Auditable Decision Ledger for Credit Payouts

## Context

- CogniDAO needs transparent, verifiable credit payouts to replace SourceCred's opaque grain scoring
- The system is a **decision ledger for human judgment** — receipts record who approved what, under which policy, with wallet-signed EIP-191 signatures
- Epoch close computes deterministic payouts from approved receipts + pre-recorded pool components — anyone can recompute and verify
- The prior design (spike.0082) had algorithmic valuation; this was rejected — valuation is human, the system makes it auditable
- Design review completed: 3 security hardening fixes applied (issuer role separation, signature domain binding, pool component trust)

## Current State

- **Design complete**: spec ([epoch-ledger.md](../../docs/spec/epoch-ledger.md)), project ([proj.transparent-credit-payouts.md](../projects/proj.transparent-credit-payouts.md)), guide ([fork-vs-build](../../docs/guides/ledger-fork-vs-build.md))
- **Identity aligned**: `user_id` (UUID) is the canonical column — no `subject_id` indirection. See [identity spec](../../docs/spec/decentralized-identity.md)
- **Not started**: All implementation — DB schema, core domain, Temporal workflows, API routes, tests
- **No implementation commits** on `feat/ledger-v0` yet — branch has design docs only

## Decisions Made

- **Issuer role separation** — `can_issue` / `can_approve` / `can_close_epoch` flags on `ledger_issuers` ([spec: Auth Model](../../docs/spec/epoch-ledger.md#auth-model))
- **Domain-bound signatures** — EIP-191 message includes `chain_id`, `app_domain`, `spec_version` to prevent replay ([spec: Receipt Signing](../../docs/spec/epoch-ledger.md#receipt-signing))
- **Pool pre-recorded** — components recorded via own workflow during epoch; close reads by reference, never creates budget ([spec: Pool Model](../../docs/spec/epoch-ledger.md#pool-model))
- **Receipts immutable** — no status column; lifecycle via append-only `receipt_events` ([spec: Receipt Lifecycle](../../docs/spec/epoch-ledger.md#receipt-lifecycle))
- **All writes via Temporal** — Next.js returns 202, `scheduler-worker` executes ([spec: Temporal Workflows](../../docs/spec/epoch-ledger.md#temporal-workflows))
- **No server keys** — issuers sign client-side, server verifies via `viem`
- **Statement unsigned in V0** — DAO multisig signing deferred to P1
- **Fork OSS for signals/UX, build the authority spine** — [guide: fork-vs-build](../../docs/guides/ledger-fork-vs-build.md)

## Next Actions

- [ ] Decompose into task work items (use `/task`)
- [ ] DB schema: 6 tables in `packages/db-schema/src/ledger.ts` + migration + append-only triggers (custom SQL)
- [ ] Core domain: `src/core/ledger/` — model, rules (BIGINT payout math, largest-remainder), signing (verify only), errors
- [ ] Port + adapter: `LedgerStore` interface → Drizzle adapter
- [ ] Temporal: 5 workflows in `services/scheduler-worker/src/` (open epoch, issue receipt, receipt event, record pool component, close epoch)
- [ ] Zod contracts: `src/contracts/ledger.*.v1.contract.ts`
- [ ] API routes: 5 write (→ Temporal 202) + 4 read (→ direct DB) under `src/app/api/v1/ledger/`
- [ ] Tests: unit (core rules, payout math), stack (full pipeline with Temporal)

## Risks / Gotchas

- Append-only DB triggers require **custom SQL migration** — not expressible in Drizzle schema DSL
- Temporal workflow IDs must be **deterministic** for idempotency (e.g. `ledger-receipt-{idempotencyKey}`)
- `scheduler-worker` uses `@cogni/db-client` for DB access — ledger activities must follow the same pattern
- `CloseEpochWorkflow` must verify `POOL_REQUIRES_BASE` before computing — at least one `base_issuance` component
- The `ledger_issuers` table must be seeded with an admin wallet before any writes work

## Pointers

| File / Resource                                                     | Why it matters                                                           |
| ------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| `docs/spec/epoch-ledger.md`                                         | V0 spec: 17 invariants, 6 tables, 5+4 API routes, 5 Temporal workflows   |
| `work/projects/proj.transparent-credit-payouts.md`                  | Project roadmap (Crawl/Walk/Run), constraints, definition of done        |
| `docs/guides/ledger-fork-vs-build.md`                               | What to build vs reuse from OSS                                          |
| `docs/spec/decentralized-identity.md`                               | Identity spec — `user_id` (UUID) is canonical for all attribution        |
| `docs/research/transparency-log-receipt-design.md`                  | Original design research (reference — some decisions superseded)         |
| `packages/db-schema/src/billing.ts`                                 | Pattern to follow: BIGINT, `.enableRLS()`, idempotency indexes           |
| `services/scheduler-worker/src/workflows/scheduled-run.workflow.ts` | Existing Temporal workflow pattern to replicate                          |
| `services/scheduler-worker/src/activities/index.ts`                 | Activity injection pattern (`createActivities(deps)`)                    |
| `src/lib/auth/server.ts`                                            | SIWE session resolver (`getServerSessionUser()` → `{id, walletAddress}`) |
