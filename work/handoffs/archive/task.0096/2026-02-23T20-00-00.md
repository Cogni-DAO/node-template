---
id: handoff.task.0096
type: handoff
work_item_id: task.0096
status: active
created: 2026-02-23
updated: 2026-02-23
branch: feat/ledger-api-routes
last_commit: 5b085991
---

# Handoff: Ledger API Routes (task.0096)

## Context

- The activity ledger collects GitHub contributions into epochs but has no HTTP API. This task exposes that data via 7 routes (3 public read, 2 auth read, 2 auth+approver write).
- The community-ledger frontend needs epoch data, allocations, and payout statements to render its 3 pages (Current Epoch, History, Holdings).
- Public routes expose only **finalized** (closed-epoch) data. Raw activity with PII (platformUserId, platformLogin) is behind SIWE auth. Write mutations require wallet membership in `activity_ledger.approvers` from repo-spec.
- Blocked by task.0095 (ledger DB schema), which is already merged.

## Current State

- **Done**: 6 Zod contracts created and typechecking clean. All 7 route handlers implemented (3 public, 2 auth read, 2 approver-gated write). Approver allowlist added to repo-spec schema + yaml + `getLedgerApprovers()` helper. DTO mappers for BigInt/Date serialization. `pnpm check` passes.
- **Not done**: Stack test (`tests/stack/ledger/ledger-api.stack.test.ts`), `src/contracts/AGENTS.md` public surface update, work item closeout (status → `needs_closeout`), PR creation.
- **Partial**: The user has already made some contract test stubs (`tests/contract/app/ledger.epochs.*.test.ts`) and other tweaks to the branch (docker-compose, scheduler env, AGENTS.md) that are uncommitted alongside our work. All uncommitted changes pass `pnpm check`.

## Decisions Made

- **Public vs auth split**: Raw activity streams are PII-adjacent; only closed-epoch allocations + statements are public. See task spec Design section for the full route/auth table.
- **Statement semantics**: Always `200 { statement: ... | null }` — no 404 ambiguity. Null = no statement yet.
- **Activity pagination**: Hard-cap 500 events per request with in-memory slice. DB-level limit/offset deferred until data volumes warrant a store port change.
- **Approver allowlist**: `activity_ledger.approvers` in `.cogni/repo-spec.yaml` (array of EVM addresses). Write routes check `sessionUser.walletAddress ∈ approvers`. Empty list = all writes rejected.
- **No facade layer**: Routes are thin — single store call each. No intermediate service files.

## Next Actions

- [ ] Write stack test: seed epoch + events + curations + allocations → query all read routes → verify contract shapes
- [ ] Update `src/contracts/AGENTS.md` — add ledger contracts to public surface list
- [ ] Commit all changes on `feat/ledger-api-routes` branch
- [ ] Update work item status to `needs_closeout`, set `updated: 2026-02-23`
- [ ] Run `/closeout` for docs pass + PR creation

## Risks / Gotchas

- `wrapPublicRoute` doesn't propagate `TContext` to the handler — dynamic routes use `context as { params: Promise<{ id: string }> }` cast. Type-safe but requires care.
- The public route enforcement meta test (`tests/meta/public-route-enforcement.test.ts`) requires either contract or stack tests for every public route. The user created stub files for this.
- `getActivityForWindow()` has no DB-level pagination — returns all events matching the window. The hard-cap prevents runaway responses, but a store port extension is needed for production scale.
- The `getLedgerApprovers()` result is cached at process level (like `getNodeId()`). Changing approvers requires process restart.
- Uncommitted changes include modifications to files outside task.0096 scope (docker-compose, scheduler env, agentic-interop project). These are user-made and should be committed separately or together per user preference.

## Pointers

| File / Resource                                   | Why it matters                                                |
| ------------------------------------------------- | ------------------------------------------------------------- |
| `work/items/task.0096.ledger-contracts-routes.md` | Full design spec with route/auth table, invariants, and plan  |
| `src/contracts/ledger.*.v1.contract.ts` (6 files) | All API shapes — single source of truth                       |
| `src/app/api/v1/public/ledger/`                   | Public routes (closed-epoch reads)                            |
| `src/app/api/v1/ledger/`                          | Auth routes (all reads + approver-gated writes)               |
| `src/app/api/v1/public/ledger/_lib/ledger-dto.ts` | BigInt/Date → string DTO mappers                              |
| `src/app/api/v1/ledger/_lib/approver-guard.ts`    | Shared approver check against repo-spec                       |
| `src/shared/config/repoSpec.schema.ts`            | `activityLedgerSpecSchema.approvers` field                    |
| `src/shared/config/repoSpec.server.ts`            | `getLedgerApprovers()` helper                                 |
| `packages/ledger-core/src/store.ts`               | `ActivityLedgerStore` port — all store methods used by routes |
| `docs/spec/epoch-ledger.md`                       | Epoch ledger spec with approver config design                 |
| `tests/meta/public-route-enforcement.test.ts`     | CI test requiring tests for every public route                |
