#cloud-config
package_update: true
package_upgrade: true
packages:
  - ca-certificates
  - curl
  - gnupg
  - lsb-release

swap:
  filename: /swapfile
  size: 2147483648

write_files:
  - path: /etc/docker/daemon.json
    owner: root:root
    permissions: "0644"
    # Reference: platform/infra/services/runtime/docker-daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        }
      }
  - path: /etc/systemd/journald.conf
    owner: root:root
    permissions: "0644"
    content: |
      [Journal]
      Storage=persistent
      SystemMaxUse=200M
      SystemMaxFileSize=50M
      RuntimeMaxUse=50M

runcmd:
  # Install Docker
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - bash -c 'echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" > /etc/apt/sources.list.d/docker.list'
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker
  - systemctl restart systemd-journald
  # Create cogni-edge network (shared between edge and runtime compose projects)
  # Must exist before any docker compose up that references it as external
  - docker network create cogni-edge || true
  # Create deployment directories (rsync targets)
  - mkdir -p /opt/cogni-template-edge /opt/cogni-template-runtime
  # Create config hash directory for checksum-gated restarts
  - mkdir -p /var/lib/cogni
