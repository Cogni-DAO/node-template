{
  log {
    level INFO
    format json
    output file /data/logs/caddy/caddy.log {
      roll_size 10MB
      roll_keep 7
      roll_keep_for 168h
    }
  }
}

# Redirect www to non-www (canonical domain)
www.{$DOMAIN} {
  redir https://{$DOMAIN}{uri} permanent
}

# Canonical domain
{$DOMAIN} {
  encode zstd gzip

  # Public API namespace - rate limited, no auth required
  # Security: Set X-Real-IP from TCP connection source (non-spoofable by client)
  # Rate limiting enforced app-side, keyed on X-Real-IP
  handle_path /api/v1/public/* {
    reverse_proxy app:3000 {
      # Set X-Real-IP from actual TCP source (cannot be spoofed by HTTP headers)
      header_up X-Real-IP {remote_host}
      # Enforce strict timeout to prevent resource exhaustion
      transport http {
        response_header_timeout 10s
      }
    }
  }

  # SourceCred public UI
  redir /sourcecred /sourcecred/
  handle_path /sourcecred/* {
    reverse_proxy sourcecred:6006
  }

  # All other requests (including /api/* non-public routes)
  reverse_proxy app:3000

  log {
    format json
    output file /data/logs/caddy/access.log {
      roll_size 10MB
      roll_keep 7
      roll_keep_for 168h
    }
  }
}
