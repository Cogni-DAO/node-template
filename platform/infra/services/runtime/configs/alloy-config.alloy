// SPDX-License-Identifier: LicenseRef-PolyForm-Shield-1.0.0
// SPDX-FileCopyrightText: 2025 Cogni-DAO
//
// Alloy configuration for Docker container log collection and metrics scraping
// Sends logs to Grafana Cloud Loki, metrics to Grafana Cloud Mimir (if configured)

// Discover all Docker containers
discovery.docker "containers" {
  host             = "unix:///var/run/docker.sock"
  refresh_interval = "10s"
}

// Relabel discovered containers with strict cardinality
// TODO: Labels (app, env) must match mimir.adapter.ts + ai-tools metrics-query description
discovery.relabel "docker_logs" {
  targets = discovery.docker.containers.targets

  // ALLOWLIST: Only keep compose services we care about
  // Drop containers that don't match our allowlist
  rule {
    source_labels = ["__meta_docker_container_label_com_docker_compose_service"]
    regex         = "(app|litellm|caddy|scheduler-worker|temporal|openclaw-gateway|llm-proxy-openclaw|autoheal)"
    action        = "keep"
  }

  // Extract compose service name â†’ "service" label
  rule {
    source_labels = ["__meta_docker_container_label_com_docker_compose_service"]
    regex         = "(.*)"
    replacement   = "${1}"
    target_label  = "service"
  }

  // Extract log stream (stdout/stderr)
  rule {
    source_labels = ["__meta_docker_container_log_stream"]
    target_label  = "stream"
  }

  // Add static labels (low cardinality)
  rule {
    target_label = "app"
    replacement  = "cogni-template"
  }

  rule {
    target_label = "env"
    replacement  = sys.env("DEPLOY_ENVIRONMENT")  // local | preview | production
  }

  // Fail-closed: Drop logs if DEPLOY_ENVIRONMENT is not valid
  // Prevents mislabeling if env var is unset or invalid
  rule {
    source_labels = ["env"]
    regex         = "^(local|preview|production)$"
    action        = "keep"
  }
}

// Collect logs from discovered containers
loki.source.docker "default" {
  host          = "unix:///var/run/docker.sock"
  targets       = discovery.relabel.docker_logs.output
  forward_to    = [loki.process.docker_logs.receiver]
  relabel_rules = discovery.relabel.docker_logs.rules
}

// =============================================================================
// Log Processing with Health-Check Noise Suppression
// =============================================================================
// Fail-safe: only drops when JSON parses AND required fields exist AND conditions
// match. Unparseable lines, missing fields, failures, and slow responses pass through.
// Same drop logic as alloy-config.metrics.alloy for dev parity.

loki.process "docker_logs" {
  stage.docker {}

  stage.timestamp {
    source = "time"
    format = "RFC3339Nano"
  }

  // Extract JSON fields from app logs (fail-safe: non-JSON lines get no extracted fields)
  stage.json {
    expressions = {
      route       = "route"
      status_code = "status"
      duration_ms = "durationMs"
      log_msg     = "msg"
    }
  }

  // Drop "request received" lines for health/metrics probe routes
  stage.template {
    source   = "drop_probe_start"
    template = "{{ if and .route .log_msg (or (eq .route \"meta.readyz\") (eq .route \"meta.metrics\")) (eq .log_msg \"request received\") }}true{{ end }}"
  }

  stage.drop {
    source              = "drop_probe_start"
    value               = "true"
    drop_counter_reason = "probe_start_noise"
  }

  // Drop successful metrics scrape completions (status=200)
  stage.template {
    source   = "drop_metrics_ok"
    template = "{{ if and .route .status_code (eq .route \"meta.metrics\") (eq .status_code \"200\") }}true{{ end }}"
  }

  stage.drop {
    source              = "drop_metrics_ok"
    value               = "true"
    drop_counter_reason = "metrics_scrape_ok"
  }

  // Drop successful fast readyz probe completions (status=200, duration < 1000ms)
  stage.template {
    source   = "drop_readyz_ok"
    template = "{{ if and .route .status_code .duration_ms (eq .route \"meta.readyz\") (eq .status_code \"200\") }}{{ if lt (int .duration_ms) 1000 }}true{{ end }}{{ end }}"
  }

  stage.drop {
    source              = "drop_readyz_ok"
    value               = "true"
    drop_counter_reason = "readyz_probe_ok"
  }

  forward_to = [loki.write.loki.receiver]
}

// Write logs to Loki (local or cloud, parameterized by env vars)
loki.write "loki" {
  endpoint {
    url = sys.env("LOKI_WRITE_URL")

    basic_auth {
      username = sys.env("LOKI_USERNAME")
      password = sys.env("LOKI_PASSWORD")
    }
  }
}

// =============================================================================
// Prometheus Metrics Scraping (Stage 9)
// =============================================================================
// For metrics shipping, use alloy-config.metrics.alloy instead (preview/prod only).
// This base config is logs-only to avoid noisy errors when PROMETHEUS_* aren't set.
// Local testing: curl http://localhost:3000/api/metrics -H "Authorization: Bearer $METRICS_TOKEN"
// =============================================================================
