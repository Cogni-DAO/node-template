# SPDX-License-Identifier: LicenseRef-PolyForm-Shield-1.0.0
# SPDX-FileCopyrightText: 2025 Cogni-DAO

# Development Infrastructure Stack
# Purpose: Provides PostgreSQL DB and LiteLLM service for local development workflow.
# Scope: Supports 'pnpm dev:stack' by running infrastructure in Docker while Next.js runs locally for hot-reload.
# Invariants: DB credentials match .env.example; LiteLLM config mirrors production; healthchecks ensure service readiness.
# Side-effects: Docker containers, volumes, host port binding (5432, 4000)
# Notes: No Caddy/Promtail to reduce dev complexity; uses dev-specific container names to avoid conflicts.

services:
  postgres:
    image: postgres:15
    container_name: cogni_dev_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: cogni_template_dev
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user"]
      interval: 10s
      timeout: 2s
      retries: 3
      start_period: 10s

  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: cogni_dev_litellm
    restart: unless-stopped
    ports:
      - "4000:4000"
    env_file:
      - ../../../../.env.local
    volumes:
      - ./configs/litellm.config.yaml:/app/config.yaml:ro
    command: --config /app/config.yaml --host 0.0.0.0 --port 4000
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://127.0.0.1:4000/health/readiness || exit 1",
        ]
      interval: 10s
      timeout: 2s
      retries: 3
      start_period: 30s

volumes:
  postgres_dev_data:
    name: cogni_dev_postgres_data
